<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

        <title>Ici c'est le soleil</title>
        <!-- <script src="https://preview.babylonjs.com/babylon.js"></script> -->
        <!-- <script src="https://preview.babylonjs.com/gui/babylon.gui.min.js"></script> -->
        <script src="lib/underscore.js"></script>
        <script src="https://cdn.babylonjs.com/babylon.js"></script>
        <script src="https://cdn.babylonjs.com/gui/babylon.gui.min.js"></script>
        <style>
            html, body {
                overflow: hidden;
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 0;
            }

            #renderCanvas {
                width: 100%;
                height: 100%;
                touch-action: none;
            }
        </style>
    </head>
<body>
    <canvas id="renderCanvas"></canvas>
    <script>
        var catalog =[
            {application: "DIORH", rapport: "arrivées 2014.rdl"},
            {application: "DIORH", rapport: "arrivées 2015.rdl"},
            {application: "DIORH", rapport: "arrivées 2016.rdl"},
            {application: "DIORH", rapport: "DashBoard.rdl"},
            {application: "DIORH", rapport: "départs 2015.rdl"},
            {application: "DIORH", rapport: "départs 2016.rdl"},
            {application: "DIORH", rapport: "DIORH_CUBE_TOP_10.rdl"},
            {application: "DIORH", rapport: "DIORH_RAPPORT_TOP_10.rdl"},
            {application: "DIORH", rapport: "Etudes Evolution Carrière.rdl"},
            {application: "DIORH", rapport: "Liste Anciennete GF NR.rdl"},
            {application: "DIORH", rapport: "Liste L0.rdl"},
            {application: "DIORH", rapport: "POC_Suivi_formation.rdl"},
            {application: "DIORH", rapport: "Promotion suite à mobilité.rdl"},
            {application: "DIORH", rapport: "Rapport_Check_DIORH_SIDSI_FER.rdl"},
            {application: "DIORH", rapport: "réalisation1.rdl"},
            {application: "DIORH", rapport: "Requête DF.rdl"},
            {application: "DIORH", rapport: "Suivi BIF.rdl"},
            {application: "DIORH", rapport: "TdB_Suivi_formation1.1.rdl"},
            {application: "SIDT", rapport: "toto.rdl"},
            {application: "SIDT", rapport: "tata.rdl"}
        ];

        var config = {
            features: {
                introduction: true
            },
            meshes: [
                {
                    name: "ceres",
                    radius: 1,
                    vertexes: 25,
                    material: {
                        diffuse: {
                            texture: "https://raw.githubusercontent.com/Servletparty/stars-Sun/master/textures/planet/2k_ceres_fictional.jpg",
                            //texture: "https://raw.githubusercontent.com/Servletparty/stars-Sun/master/textures/planet/2k_makemake_fictional.jpg",
                            color: new BABYLON.Color3(1, 1, 1)
                        },
                        specular: {
                            color: new BABYLON.Color3(0, 0, 0)
                        },
                        bump: {}
                    },
                    position: new BABYLON.Vector3(10, 0, 5),
                    rotation: {y: 1, z: Math.PI},
                    renderingGroupId: 3,
                    camera: "default"
                },
                {
                    name: "moon",
                    parent: "ceres",
                    radius: 0.2,
                    vertexes: 25,
                    material: {
                        diffuse: {
                            texture: "https://raw.githubusercontent.com/Servletparty/stars-Sun/master/textures/planet/moon.jpg"
                        },
                        bump: {
                            texture: "https://raw.githubusercontent.com/Servletparty/stars-Sun/master/textures/planet/moon_bump.jpg",
                        },
                        specular: {
                            texture: "https://raw.githubusercontent.com/Servletparty/stars-Sun/master/textures/planet/moon_spec.jpg"
                        }
                    },
                    position: new BABYLON.Vector3(1, -0.2, 0.5),
                    rotation: {},
                    renderingGroupId: 3
                },
                {
                    name: "eris",
                    radius: 2,
                    vertexes: 25,
                    material: {
                        diffuse: {
                            texture: "https://raw.githubusercontent.com/Servletparty/stars-Sun/master/textures/planet/2k_eris_fictional.jpg",
                            color: new BABYLON.Color3(1, 1, 1)
                        },
                        specular: {
                            color: new BABYLON.Color3(0, 0, 0)
                        },
                        bump: {}
                    },
                    position: new BABYLON.Vector3(15, 0, 5),
                    rotation: {y: 1, z: Math.PI},
                    renderingGroupId: 3,
                    camera: "default"
                },
                {
                    name: "haumea",
                    radius: 2,
                    vertexes: 25,
                    material: {
                        diffuse: {
                            texture: "https://raw.githubusercontent.com/Servletparty/stars-Sun/master/textures/planet/2k_haumea_fictional.jpg",
                            color: new BABYLON.Color3(1, 1, 1)
                        },
                        specular: {
                            color: new BABYLON.Color3(0, 0, 0)
                        },
                        bump: {}
                    },
                    position: new BABYLON.Vector3(15, 0, 5),
                    rotation: {y: 1, z: Math.PI},
                    renderingGroupId: 3,
                    camera: "default"
                },
                {
                    name: "makemake",
                    radius: 2,
                    vertexes: 25,
                    material: {
                        diffuse: {
                            texture: "https://raw.githubusercontent.com/Servletparty/stars-Sun/master/textures/planet/2k_makemake_fictional.jpg",
                            color: new BABYLON.Color3(1, 1, 1)
                        },
                        specular: {
                            color: new BABYLON.Color3(0, 0, 0)
                        },
                        bump: {}
                    },
                    position: new BABYLON.Vector3(15, 0, 5),
                    rotation: {y: 1, z: Math.PI},
                    renderingGroupId: 3,
                    camera: "default"
                }
            ]
        };

        var planetBuilder = function(mesh, scene){
            var planet = BABYLON.Mesh.CreateSphere(mesh.name, mesh.vertexes, mesh.radius, scene);
            planet.position = mesh.position;
            planet.rotation.y = ('y' in mesh.rotation) ? mesh.rotation.y : 0
            planet.rotation.z = ('z' in mesh.rotation) ? mesh.rotation.z : 0
            planet.renderingGroupId = ('renderingGroupId' in mesh) ? mesh.renderingGroupId : 3;

            var planetMat = new BABYLON.StandardMaterial(mesh.name + "Surface", scene);
            planetMat.diffuseTexture = ('texture' in mesh.material.diffuse) ? new BABYLON.Texture(mesh.material.diffuse.texture, scene): null;
            planetMat.bumpTexture = ('texture' in mesh.material.bump) ? new BABYLON.Texture(mesh.material.bump.texture, scene): null;
            planetMat.specularTexture = ('texture' in mesh.material.specular) ? new BABYLON.Texture(mesh.material.specular.texture, scene): null;
            planet.material = planetMat;

            if(mesh.material.diffuse.color)
                planet.material.diffuseColor  = mesh.material.diffuse.color;
            if(mesh.material.specular.color)
                planet.material.specularColor = mesh.material.specular.color;

            // planet.checkCollisions = true;

            return planet;
        }

        var initCamera = function(canvas, type){
            var camera;
            if(type == 'FreeCamera'){
                camera = new BABYLON.FreeCamera("FCamera", new BABYLON.Vector3(-8.4, 0, 0), scene);
                camera.rotation.y = Math.PI/1.35;
            }                
            else{
                camera = new BABYLON.ArcRotateCamera("ACamera", -Math.PI / 2, 3*Math.PI / 7, 110, new BABYLON.Vector3(55, 5, 55), scene);
                camera.attachControl(canvas, true);
            }
            
            if(!config.features.introduction) camera.attachControl(canvas, true);
			
            camera.speed = 0.1;
            camera.lowerRadiusLimit = 2.3;
            camera.upperRadiusLimit = 7;
            camera.pinchDeltaPercentage = 0.01;
            camera.wheelDeltaPercentage = 0.01;
            camera.angularSensibility = 1500;
            
            //camera.ellipsoid = new BABYLON.Vector3(50, 50, 50);
            //camera.checkCollisions = true;
			
			camera.keysUp = [90]; // Touche Z
			camera.keysDown = [83]; // Touche S
			camera.keysLeft = [81]; // Touche Q
			camera.keysRight = [68]; // Touche D;

            return camera;
        }

        var createScene = function (data) {
            var scene = new BABYLON.Scene(engine);

            var camera = initCamera(canvas, 'FreeCamera');
            scene.activeCamera = camera;
            //var attachedCamera = false;

            scene.clearColor = new BABYLON.Color3(0.0, 0.0, 0.0);
            
            var planets = [];
            config.meshes.forEach(mesh => {
                var planet = planetBuilder(mesh, scene);
                if(mesh.parent)
                    planet.parent = planets.find(function(p){ return p.id = mesh.parent; });
                planets.push(planet);
            });

            BABYLON.ParticleHelper.BaseAssetsUrl = "https://raw.githubusercontent.com/Servletparty/stars-Sun/master/particles";
            BABYLON.ParticleHelper.CreateAsync("blueStar", scene, true).then(function(set){ 
                set.start();
            });

            var light = new BABYLON.PointLight("DirLight", new BABYLON.Vector3(0, 0, 0), scene);
			light.diffuse = new BABYLON.Color3(1, 1, 1);
			light.specular = new BABYLON.Color3(0.6, 0.6, 0.6);
			light.intensity = 2;
            
            // GUI
            var advancedTexture = BABYLON.GUI.AdvancedDynamicTexture.CreateFullscreenUI("ui1");

            var panel = new BABYLON.GUI.StackPanel();  
            panel.width = 0.25;
            panel.rotation = 0.2;
            panel.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT;
            advancedTexture.addControl(panel);

            var createLabel = function(mesh, data) {
                var label = new BABYLON.GUI.Rectangle("label for " + mesh.name);
                label.background = "black"
                label.height = "30px";
                label.alpha = 0.5;
                label.width = "100px";
                label.cornerRadius = 20;
                label.thickness = 1;
                label.linkOffsetY = 80;
                advancedTexture.addControl(label); 
                label.linkWithMesh(mesh);

                var text1 = new BABYLON.GUI.TextBlock();
                var counts = _.countBy(data,'application');
                var appName = data[0].application;
                text1.text = appName + ': ' + counts.DIORH;
                text1.color = "white";
                label.addControl(text1);  
            } 

            //createLabel(planets[0], data);

            var distanceFromObject = function(mesh, cam){
                return  mesh.position.subtract(cam.position).length();
            }

            var introductionSceneEnded = false;
            var introductionSceneRunning = 0;
            var introductionScene = function(mesh, cam){
                var distance = mesh.position.subtract(cam.position).length();
                if(distance < 13){
                    introductionSceneRunning = 1;
                    camera.rotation.y += 1/distance/30;
                }else{
                    if(introductionSceneRunning > 0){
                        introductionSceneEnded = true;
                        camera = initCamera(canvas);
                        scene.activeCamera = camera;
                        var i = planets.length - 1;
                        camera.target = mesh;
                        //camera.target = planets[i];
                        createLabel(mesh, data);
                    }
                }
            }

            var alpha = Math.PI;
            scene.beforeRender = function () {
                if(config.features.introduction && !introductionSceneEnded)
                    introductionScene(planets[0], camera);
                planets.forEach(function(planet, index){
                    if(!planet.parent){
                        if(index == 0){
                            planet.position = new BABYLON.Vector3(10 * Math.sin(alpha), 0, 10 * Math.cos(alpha));
                        }
                        else
                        {
                            
                            planet.position = new BABYLON.Vector3(10 * Math.cos(alpha) * index * -1, 0, 10 * Math.sin(alpha) * index * -1);
                        }
                            
                        //planet.position = new BABYLON.Vector3(10 * Math.sin(alpha*index) * (Math.pow(index, index)), 0, 10 * Math.cos(alpha*index) * Math.pow(index, index));
                        planet.rotation.y += .01 * (index + 1);
                    }
                });
                alpha += 0.005; 
            };

            return scene;
        }

        function createSkybox(scene) {
			var sMaterial = new BABYLON.StandardMaterial("skyboxMaterial", scene);
			sMaterial.backFaceCulling = false;
            sMaterial.reflectionTexture = new BABYLON.CubeTexture("https://raw.githubusercontent.com/Servletparty/stars-Sun/master/skybox/universe/skybox", scene);
			sMaterial.reflectionTexture.coordinatesMode = BABYLON.Texture.SKYBOX_MODE;
            sMaterial.disableLighting = true;
            
			var skybox = BABYLON.Mesh.CreateBox("skybox", 250, scene);
			skybox.material = sMaterial;
		}

        var canvas = document.getElementById("renderCanvas");
        var engine = new BABYLON.Engine(canvas, true, { preserveDrawingBuffer: true, stencil: true });
        var scene = createScene(catalog);
        createSkybox(scene);

        engine.runRenderLoop(function () {
            if (scene) {
                scene.render();
            }
        });

        // Resize
        window.addEventListener("resize", function () {
            engine.resize();
        });
    </script>
</body>
</html>
